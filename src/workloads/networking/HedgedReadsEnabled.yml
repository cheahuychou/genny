SchemaVersion: 2018-07-01
Owner: "@mongodb/service-architecture"

Clients:
  Default:
    QueryOptions:
      maxPoolSize: 5000
      socketTimeoutMS: 5000
      connectTimeoutMS: 5000

Actors:
- Name: EnableSharding
  Type: AdminCommand
  Threads: 1
  Phases:
  - Repeat: 1
    Database: admin
    Operations:
    - OperationMetricsName: EnableSharding
      OperationName: AdminCommand
      OperationCommand:
        enableSharding: &db test
  - &Nop {Nop: true}
  - *Nop
  - *Nop

- Name: ShardCollection
  Type: AdminCommand
  Threads: 1
  Phases:
  - *Nop
  - Repeat: 1
    Database: admin
    Operations:
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0 # Collection0 is the default collection populated by the Loader.
        key:
          _id: hashed
  - *Nop
  - *Nop

- Name: InsertData
  Type: Loader
  Threads: 1
  Phases:
  - *Nop
  - *Nop
  - Repeat: 1
    Database: *db
    Threads: 1
    CollectionCount: 1
    DocumentCount: 100
    BatchSize: 100
    Document:
      x: {^RandomInt: {min: -1000, max: 1000}}
  - *Nop

- Name: HedgedReadsEnabled
  Type: RunCommand
  Threads: 100
  Phases:
  - *Nop
  - *Nop
  - *Nop
  - GlobalRate: 1000 per 1 second
    Duration: 8 minutes
    ThrowOnFailure: false
    Database: *db
    Operation:
      OperationMetricsName: Count
      OperationName: RunCommand
      OperationCommand:
        count: Collection0
        query: {x: {$gt: {^RandomInt: {min: -1000, max: 1000}}}}
        $readPreference: {mode: nearest, hedge: {enabled: true}}
